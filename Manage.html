<html>
<head>
    <title>PSO Scope Manager</title>
</head>
<body>
    <div id="angularContainer" ng-app="application" ng-controller="ManageCtrl">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css" type="text/css" />
        <link rel="stylesheet" href="/bootstrap.css" />
        <div class="container-fluid">
            <div class="col-md-10 col-md-offset-1">
                <div class="row" ng-repeat="engineer in engineerList">
                    <div class="row"><h4>{{engineer.name}}</h4></div>
                    <div class="row text-left text-primary">
                        <div class="col-xs-1 col-md-1">Priority</div>
                        <div class="col-xs-2 col-md-2">Customer Name</div>
                        <div class="col-xs-1 col-md-1">Gears ID</div>
                        <div class="col-xs-1 col-md-1">Type #</div>
                        <div class="col-xs-2 col-md-2">Classification</div>
                        <div class="col-xs-2 col-md-2">Engagement Manager</div>
                        <div class="col-xs-1 col-md-1">Hours</div>
                        <div class="col-xs-1 col-md-1">Forecast</div>
                    </div>
                    <div class="row text-left" ng-repeat="entry in recordsList[$index] | orderBy:'priority'">
                        <input class="col-xs-1 col-md-1 btn-success" ng-model="entry.priority" ng-model-options="{ updateOn: 'blur' }" ng-change="updateRecord(entry)" />
                        <input class="col-xs-2 col-md-2 btn-primary" ng-model="entry.customerName" ng-change="updateRecord(entry)" />
                        <input class="col-xs-1 col-md-1 btn-primary" ng-model="entry.gearsId" ng-change="updateRecord(entry)" />
                        <input class="col-xs-1 col-md-1 btn-info" ng-model="entry.typeRefNumber" disabled ng-change="updateRecord(entry)" />
                        <select class="col-xs-2 col-md-2 btn-primary" ng-model="entry.typeText" ng-change="updateRecord(entry)">
                            <option ng-repeat="type in types" ng-selected="entry.typeRefNumber - 1 == $index">{{type}}</option>
                        </select>
                        <input class="col-xs-2 col-md-2 btn-primary" ng-model="entry.engagementManager" ng-change="updateRecord(entry)" />
                        <input class="col-xs-1 col-md-1 btn-warning" ng-model="entry.hours" ng-model-options="{ updateOn: 'blur' }" ng-change="updateRecord(entry)">
                        <input class="col-xs-1 col-md-1 btn-info" ng-model="entry.forecast" disabled>
                        <button class="col-xs-1 col-md-1 btn-danger" ng-click="removeRecord(entry)">Delete</button>
                    </div>
                    <br />
                </div>
                <div class="row">
                    <div class="row">
                        <select ng-model="newRecord.owner">
                            <option value="">Choose Engineer:</option>
                            <option value="{{engineer.name}}" ng-repeat="engineer in engineerList">{{engineer.name}}</option>
                        </select>
                    </div>
                    <form ng-submit="addRecord(newRecord)" class="row">
                        <input class="col-xs-1 col-md-1" value="" ng-model="newRecord.priority" />
                        <input class="col-xs-2 col-md-2" value="" ng-model="newRecord.customerName" />
                        <input class="col-xs-1 col-md-1" value="" ng-model="newRecord.gearsId" />
                        <input disabled class="col-xs-1 col-md-1" value="" ng-model="newRecord.typeRefNumber" />
                        <select class="col-xs-2 col-md-2 text-center" ng-model="newRecord.typeText" ng-change="updateTypes()">
                            <option value="">Choose Class</option>
                            <option value="{{type}}" ng-repeat="type in types">{{type}}</option>
                        </select>
                        <input class="col-xs-2 col-md-2" value="" ng-model="newRecord.engagementManager" />
                        <input class="col-xs-1 col-md-1" value="" ng-model="newRecord.hours" />
                        <input disabled class="col-xs-1 col-md-1">
                        <button class="col-xs-1 col-md-1 btn-success" type="submit">Add</button>
                    </form>
                </div>
            </div>
        </div>
        <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
        <script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.2/angular.min.js"></script>
        <script type="text/javascript" src="https://cdn.firebase.com/js/client/2.2.0/firebase.js"></script>
        <script type="text/javascript" src="https://cdn.firebase.com/libs/angularfire/0.9.2/angularfire.min.js"></script>
        <script>
            var app = angular.module("application", ["firebase"]);
            var baseUrl = "http://localhost:3000";


            app.factory("dbFactory", function ($http) {
                var service = {};
                var baseUrl = "http://localhost:3000";

                service.getUsers = function (callback) {
                    $http.get(baseUrl + '/users').
                    success(function (data, status, headers, config) {
                        data.success = true;
                        callback(data);
                    }).
                    error(function (data, status, headers, config) {
                        console.log("GET Error in 'getUsers() Status: " + status);
                        callback({ "success": false });
                    });
                }

                service.getRecordsByUser = function (userName, index, callback) {
                    $http.get(baseUrl + '/user/' + userName).
                    success(function (data, status, headers, config) {
                        data.success = true;
                        callback(data, index);
                    }).
                    error(function (data, status, headers, config) {
                        console.log("GET Error in 'getRecordsByUser() Status: " + status);
                        callback({ "success": false });
                    });
                }

                service.getTypes = function (callback) {
                    $http.get(baseUrl + '/types').
                    success(function (data, status, headers, config) {
                        data.success = true;
                        callback(data);
                    }).
                    error(function (data, status, headers, config) {
                        console.log("GET Error in 'getTypes() Status: " + status);
                        callback({ "success": false });
                    });
                }

                service.removeRecord = function (id, callback) {
                    $http.post(baseUrl + '/remove/' + id).
                    success(function (data, status, headers, config) {
                        data.success = true;
                        callback(data);
                    }).
                    error(function (data, status, headers, config) {
                        console.log("POST Error in 'removeRecord() Status: " + status);
                        callback({ "success": false });
                    });
                }

                service.addRecord = function (record, callback) {
                    $http.post(baseUrl + '/add', record).
                    success(function (data, status, headers, config) {
                        data.success = true;
                        callback(data);
                    }).
                    error(function (data, status, headers, config) {
                        console.log("POST Error in 'addRecord() Status: " + status);
                        callback({ "success": false });
                    });
                }

                service.updateRecord = function(record, callback) {
                    $http.post(baseUrl + '/update', record).
                    success(function (data, status, headers, config) {
                        data.success = true;
                        callback(data);
                    }).
                    error(function (data, status, headers, config) {
                        console.log("POST Error in 'updateRecord() Status: " + status);
                        callback({ "success": false });
                    });
                }

                return service;
            });

            app.controller("ManageCtrl", function ($scope, $firebase, $http, dbFactory) {

                $scope.types = new Array();
                dbFactory.getTypes(function (data) {
                    if (data.success) {
                        $scope.types = data.list;
                    }
                });

                $scope.engineerList = new Array();
                dbFactory.getUsers(function (data) {
                    if (data.success) {
                        $scope.engineerList = data;
                    }
                });

                function loadRecords() {
                    $scope.recordsList = new Array($scope.engineerList.length);
                    for (var i = 0; i < $scope.engineerList.length; i++) {
                        dbFactory.getRecordsByUser($scope.engineerList[i].name, i, function (data, ownerIndex) {
                            if (data.success) {
                                $scope.recordsList[ownerIndex] = data;
                                //TODO Check Priority

                                //These two loops handle hours forecasting and rounding
                                //The alternative is a single loop where we add the new hours to the previously rounded forecast
                                //This method preserves total hours for each forecast before rounding
                                for (var j = 0; j < $scope.recordsList[ownerIndex].length; j++) {
                                    $scope.recordsList[ownerIndex][j].forecast = $scope.recordsList[ownerIndex][j].hours;
                                    if (j > 0) {
                                        $scope.recordsList[ownerIndex][j].forecast += $scope.recordsList[ownerIndex][j - 1].hours;
                                    }
                                }
                                for (j = 0; j < $scope.recordsList[ownerIndex].length; j++) {
                                    var totalHours = $scope.recordsList[ownerIndex][j].forecast / $scope.engineerList[ownerIndex].hours;
                                    $scope.recordsList[ownerIndex][j].forecast = Math.round(totalHours * 10) / 10;
                                }
                            }
                        });
                    }                    
                }

                $scope.$watch("engineerList", function (newValue, oldValue) {
                    if ($scope.engineerList.length > 0) {
                        loadRecords();
                    }
                });

                $scope.removeRecord = function (entry) {
                    console.log(entry._id);
                    dbFactory.removeRecord(entry._id, function (data) {
                        if (data.success) {
                            loadRecords();
                        }
                    });
                }

                $scope.addRecord = function (entry) {
                    entry.priority = parseInt(entry.priority);
                    entry.gearsId = parseInt(entry.gearsId);
                    entry.hours = parseInt(entry.hours);

                    dbFactory.addRecord(entry, function(data) {
                        if (data.success) {
                            loadRecords();
                            $scope.newRecord = {};
                        }
                    });
                }

                $scope.updateRecord = function (record) {
                    if (record.typeText != undefined) {
                        var index = $scope.types.indexOf(record.typeText);
                        record.typeRefNumber = index > -1 ? index + 1 : null;
                    }

                    dbFactory.updateRecord(record, function(data) {
                        if (data.success) {
                            console.log(data);
                            loadRecords();
                        }
                    });
                }

                $scope.updateRecordHours = function (engineerNum) {
                    var index;
                    for (var i = 0; i <= findGreatestPriorityValue(engineerNum) ; i++) {
                        index = findPriority(engineerNum, i, null);
                        if (index > -1) {
                            $scope.recordsList[engineerNum][index].forecast = getRecordForecast(engineerNum, $scope.recordsList[engineerNum][index]);
                            $scope.updateRecord(engineerNum, $scope.recordsList[engineerNum][index]);
                        }
                    }
                }

                function getRecordForecast(engineerNum, entry) {
                    var hours = scopes[engineerNum].hours;
                    var index = findNextLowerPriorityIndex(engineerNum, entry.priority, entry.$id);
                    var forecast = 0;
                    if (entry.hours == "") {
                        hours = 0;
                        forecast = 0;
                    } else if (index > -1) {
                        forecast = $scope.recordsList[engineerNum][index].forecast;
                    }
                    forecast += entry.hours / hours;
                    return Math.round(forecast * 10) / 10;
                }

                $scope.updateRecordPriority = function (engineerNum, entry) {
                    entry.priority = parseInt(entry.priority);
                    if (entry.priority < 1)
                        entry.priority = 1;
                    $scope.updateRecord(engineerNum, entry);

                    var p = entry.priority;
                    var index = findPriority(engineerNum, p, entry.$id);
                    while (index != -1) {
                        $scope.recordsList[engineerNum][index].priority += 1;
                        $scope.recordsList[engineerNum].$save(index);
                        index = findPriority(engineerNum, $scope.recordsList[engineerNum][index].priority, $scope.recordsList[engineerNum][index].$id);
                    }

                    $scope.updateRecordHours(engineerNum);
                }

                function findPriority(engineerNum, p, id) {
                    for (var i = 0; i < $scope.recordsList[engineerNum].length; i++) {
                        if ($scope.recordsList[engineerNum][i].priority == p && $scope.recordsList[engineerNum][i].$id != id)
                            return i;
                    }
                    return -1;
                };

                function findNextLowerPriorityIndex(engineerNum, p) {
                    var index = -1;
                    var priority = -1;
                    for (var i = 0; i < $scope.recordsList[engineerNum].length; i++) {
                        var tp = $scope.recordsList[engineerNum][i].priority;
                        if (tp < p) {
                            if (p - tp < p - priority) {
                                priority = tp;
                                index = i;
                            }
                        }
                    }
                    return index;
                }

                function findNextHigherPriorityIndex(engineerNum, p) {
                    var index = -1;
                    var priority = 999999;
                    for (var i = 0; i < $scope.recordsList[engineerNum].length; i++) {
                        var tp = $scope.recordsList[engineerNum][i].priority;
                        if (tp > p) {
                            if (tp - p < priority - p) {
                                priority = tp;
                                index = i;
                            }
                        }
                    }
                    return index;
                }

                function findGreatestPriorityValue(engineerNum) {
                    var p = -1;
                    for (var i = 0; i < $scope.recordsList[engineerNum].length; i++) {
                        if ($scope.recordsList[engineerNum][i].priority > p) {
                            p = $scope.recordsList[engineerNum][i].priority;
                        }
                    }
                    return p;
                }

                function findLowestPriorityValue(engineerNum) {
                    var p = $scope.recordsList[engineerNum][0].priority;
                    for (var i = 0; i < scopes.recordsList[engineerNum].length; i++) {
                        if ($scope.recordsList[engineerNum][i].priority < p) {
                            p = $scope.recordsList[engineerNum][i].priority;
                        }
                    }
                    return p;
                }

                $scope.updateRecordType = function (engineerNum, entry) {
                    //$scope.types is an array of objects not just "text"
                    for (var i = 0; i < $scope.types.length; i++) {
                        if (entry.typeText == $scope.types[i].$value) {
                            console.log(i + 1);
                            entry.typeNumber = i + 1;
                        }
                    }
                    $scope.updateRecord(engineerNum, entry);
                    //TODO: Notify of bad input
                }

                $scope.updateTypes = function () {
                    var index = $scope.types.indexOf($scope.newRecord.typeText);
                    $scope.newRecord.typeRefNumber = index > -1 ? index + 1 : null;
                }

            });
        </script>
    </div>
</body>
</html>